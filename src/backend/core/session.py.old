"""
Async database session management for SQLModel with MariaDB.

Provides:
- Async engine creation with aiomysql driver
- AsyncSession factory for request-scoped sessions
- Database initialization and cleanup
"""

from typing import AsyncGenerator, Optional

from sqlalchemy.ext.asyncio import (
    AsyncSession,
    async_sessionmaker,
    create_async_engine,
)
from sqlalchemy.pool import NullPool
from sqlmodel import SQLModel

from settings import settings


class DatabaseManager:
    """Manages async database connection and session lifecycle."""

    _engine = None
    _async_session_maker = None

    @classmethod
    def get_engine(self):
        """Get or create the async engine."""
        if self._engine is None:
            if not settings.MARIA_URL:
                raise ValueError(
                    "MARIA_URL not configured in settings. "
                    "Please set MARIA_URL in .env or environment variables."
                )

            self._engine = create_async_engine(
                settings.MARIA_URL,
                echo=settings.ENVIRONMENT == "development",
                pool_pre_ping=True,  # Verify connections are live before use
                poolclass=NullPool,  # Use NullPool for async with aiomysql
            )

        return self._engine

    @classmethod
    def get_session_maker(self):
        """Get or create the async session factory."""
        if self._async_session_maker is None:
            engine = self.get_engine()
            self._async_session_maker = async_sessionmaker(
                engine,
                class_=AsyncSession,
                expire_on_commit=False,
            )

        return self._async_session_maker

    @classmethod
    async def init_db(self) -> None:
        """
        Initialize the database by creating all tables.

        This should be called once during application startup
        after all models have been imported.
        """
        engine = self.get_engine()

        async with engine.begin() as conn:
            await conn.run_sync(SQLModel.metadata.create_all)

    @classmethod
    async def dispose(self) -> None:
        """Dispose of the engine and clean up connections."""
        if self._engine is not None:
            await self._engine.dispose()
            self._engine = None
            self._async_session_maker = None


async def get_async_session() -> AsyncGenerator[AsyncSession, None]:
    """
    Dependency for FastAPI endpoints to get an async database session.

    Each endpoint gets its own session that is automatically closed after
    the response is sent.

    Usage in FastAPI endpoint:
        @app.get("/users/{user_id}")
        async def get_user(user_id: int, session: AsyncSession = Depends(get_async_session)):
            # Use session for database operations
            pass

    Yields:
        AsyncSession for use in the endpoint

    Example:
        @app.get("/")
        async def root(session: AsyncSession = Depends(get_async_session)):
            result = await session.execute(select(User))
            return result.scalars().all()
    """
    session_maker = DatabaseManager.get_session_maker()

    async with session_maker() as session:
        try:
            yield session
        finally:
            await session.close()


async def setup_database() -> None:
    """
    Setup database during application startup.

    This function:
    1. Initializes the database (creates tables)
    2. Can be extended for seed data, migrations, etc.

    Call this in your FastAPI lifespan event:
        async def lifespan(app: FastAPI):
            await setup_database()
            yield
            await DatabaseManager.dispose()

        app = FastAPI(lifespan=lifespan)
    """
    await DatabaseManager.init_db()


async def init_db() -> None:
    """Alias for setup_database for backward compatibility."""
    await setup_database()
